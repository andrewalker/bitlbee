#!/bin/sh

##############################
##  Configurer for BitlBee  ##
##                          ##
##  Copyright 2002 Lintux   ##
##  Copyright 2002 Lucumo   ##
##############################

prefix='/usr/local'
bindir='$prefix/sbin'
etcdir='$prefix/etc'
mandir='$prefix/share/man'
config='/var/lib/bitlbee/'

debug=0
strip=1
tcpd=1

arch=`uname -s`

while [ -n "$1" ]; do
	e="`expr "$1" : '--\(.*=.*\)'`"
	if [ -z "$e" ]; then
		cat<<EOF
BitlBee configure

Usage: $0 [OPTIONS]

Option		Description				Default

--prefix=...	Directories to put files in		$prefix
--bindir=...						$bindir
--etcdir=...						$etcdir
--mandir=...						$mandir
--config=...						$config

--debug=0/1	Disable/enable debugging		$debug
--strip=0/1	Disable/enable binary stripping		$strip

--tcpd=0/1	/etc/hosts.{allow,deny} support		$tcpd
EOF
		exit;
	fi
	eval "$e"
	shift;
done

echo -n 'Checking for GNU autoconf... ' >&2

# Expand $prefix
bindir=`eval echo $bindir`
etcdir=`eval echo $etcdir`
mandir=`eval echo $mandir`
config=`eval echo $config`

cat<<EOF>Makefile.settings
## BitlBee settings, generated by configure
PREFIX=$prefix
BINDIR=$bindir
ETCDIR=$etcdir
MANDIR=$mandir
CONFIG=$config

ARCH=$arch
OUTFILE=bitlbee

DESTDIR=
LFLAGS=

EOF

cat<<EOF>config.h
/* BitlBee settings, generated by configure */
#define CONFIG "$config"
#define ETCDIR "$etcdir"
#define ARCH "$arch"
EOF

if [ "$debug" = "1" ]; then
	echo 'CFLAGS=-g' >> Makefile.settings
	echo 'DEBUG=1' >> Makefile.settings
else
	echo 'CFLAGS=-O3' >> Makefile.settings;
fi

echo 'NOT found, okay! ;-)'
echo

echo CFLAGS+=-I`pwd` -I`pwd`/protocols -I. >> Makefile.settings

if type gcc > /dev/null 2> /dev/null; then
	echo "CC=gcc" >> Makefile.settings;
elif type cc > /dev/null 2> /dev/null; then
	echo "CC=cc" >> Makefile.settings;
else
	echo 'Cannot find a C compiler, aborting.'
	exit 1;
fi

if type ld > /dev/null 2> /dev/null; then
	echo "LD=ld" >> Makefile.settings;
else
	echo 'Cannot find ld, aborting.'
	exit 1;
fi

if type glib-config > /dev/null 2> /dev/null; then
	cat<<EOF>>Makefile.settings
LFLAGS+=`glib-config --libs`
CFLAGS+=`glib-config --cflags`
EOF
else
	echo 'Cannot find glib development libraries, aborting. (Install libglib-dev?)'
	exit 1;
fi

if [ -e /usr/include/tcpd.h -a "$tcpd" = "1" ]; then
	cat<<EOF>>Makefile.settings
LFLAGS+=-lwrap
EOF
elif [ -e /usr/local/include/tcpd.h -a "$tcpd" = "1" ]; then
	cat<<EOF>>Makefile.settings
LFLAGS+=-L/usr/local/lib
CFLAGS+=-I/usr/local/include
EOF
else
	tcpd=0
	echo 'Compiling without tcpd support, /etc/hosts.{allow,deny} will be ignored!'
	echo
	echo '#define NO_TCPD' >> config.h
fi

if [ "$strip" = 0 ]; then
	echo "STRIP=\# skip strip" >> Makefile.settings;
else
	echo 'The strip option is enabled. This should not be a problem usually, but on some'
	echo 'systems it breaks stuff.'
	echo
	if [ "$debug" = 1 ]; then
		echo 'Stripping binaries does not make sense when debugging. Stripping disabled.'
		echo
		echo 'STRIP=\# skip strip' >> Makefile.settings
		strip=0;
	elif type strip > /dev/null 2> /dev/null; then
		echo "STRIP=strip" >> Makefile.settings;
	elif /bin/test -x /usr/ccs/bin/strip; then
		echo "STRIP=/usr/ccs/bin/strip" >> Makefile.settings;
	else
		echo 'No strip utility found, cannot remove unnecessary parts from executable.'
		echo ''
		echo 'STRIP=\# skip strip' >> Makefile.settings
		strip=0;
	fi;
fi

echo Architecture: $arch
case "$arch" in
Linux )
	echo 'Linux is our primary development platform, BitlBee should work well.'
;;
* )
	echo 'We haven'\''t tested BitlBee on many platforms yet, yours is untested. YMMV.'
;;
esac
echo

echo 'Configuration done:'
if [ "$debug" = "1" ]; then
	echo '  Debugging enabled.';
else
	echo '  Debugging disabled.';
fi
if [ "$strip" = "1" ]; then
	echo '  Binary stripping enabled.';
else
	echo '  Binary stripping disabled.';
fi
if [ "$tcpd" = "0" ]; then
	echo '  Tcpd support disabled.';
else
	echo '  Tcpd support enabled.';
fi
